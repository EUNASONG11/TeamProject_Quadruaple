<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.project_quadruaple.trip.TripMapper">
    <select id="getTripList">
        SELECT
            t.trip_id AS tripId
            , t.title AS title
            , t.start_at AS startAt
            , t.end_at AS endAt
            , l.location_pic AS locationPic
            , count(sm.schedule_memo_id) AS scheduleCnt
        FROM trip t
        JOIN trip_user tu
            ON tu.trip_id = t.trip_id
            AND tu.user_id = #{userId}
        JOIN trip_location tl
            ON tl.trip_id = t.trip_id
        LEFT JOIN location l
            ON l.location_id = tl.location_id
        JOIN sche_memo sm
            ON sm.trip_id = t.trip_id
            AND sm.category = 'SCHE'
        GROUP BY t.trip_id
    </select>

    <select id="selLocationList">
        SELECT
            location_id
            , location_pic
            , title
        FROM location
    </select>

    <insert id="insTrip" useGeneratedKeys="true" keyProperty="tripId">
        INSERT INTO trip
        SET title = #{title}
            , manager_id = #{managerId}
            , start_at = #{startAt}
            , end_at = #{endAt}
    </insert>

    <insert id="insTripLocation">
        INSERT INTO trip_location
        (trip_id, location_id)
        VALUES
        <foreach collection="idList" item="id" separator=",">
            (#{tripId}, #{id})
        </foreach>
    </insert>
    
    <select id="selScheduleCntAndMemoCnt">
        SELECT
            count(sms.category) AS scheduleCnt
            , count(smm.category) AS memoCnt
        FROM sche_memo sm
        LEFT JOIN (
            SELECT * FROM sche_memo
            WHERE trip_id = #{tripId}
                AND category = 'SCHE') sms
            ON sm.schedule_memo_id = sms.schedule_memo_id
        LEFT JOIN (
            SELECT * FROM sche_memo
            WHERE trip_id = #{tripId}
                AND category = 'MEMO') smm
            ON sm.schedule_memo_id = smm.schedule_memo_id
    </select>

    <select id="selScheduleDetail" resultMap="scheduleForDay">
        SELECT
            sm.`day` AS day
            , sm.seq AS seq
            , s.distance AS distance
            , s.duration AS duration
            , s.strf_id AS strfId
            , s.pathtype AS pathType
            , strf.title AS strfTitle
            , strf.category AS category
            , strf.address AS address
            , strf.lat AS lat
            , strf.lng as lng
        FROM sche_memo sm
        LEFT JOIN schedule s
            ON sm.schedule_memo_id = s.schedule_id
        JOIN stay_tour_restaur_fest strf
            ON strf.strf_id = s.strf_id
        WHERE sm.trip_id = #{tripId}
            AND sm.category = "SCHE"
    </select>

    <resultMap id="scheduleForDay" type="com.green.project_quadruaple.trip.model.dto.TripDetailDto">
        <id column="day" property="day"/>
        <collection property="schedules" ofType="com.green.project_quadruaple.trip.model.dto.ScheduleDto">
            <id column="seq" property="seq"/>
            <result column="distance" property="distance"/>
            <result column="duration" property="duration"/>
            <result column="strfId" property="strfId"/>
            <result column="strfTitle" property="strfTitle"/>
            <result column="category" property="category"/>
            <result column="address" property="address"/>
            <result column="lat" property="lat"/>
            <result column="lng" property="lng"/>
            <result column="pathType" property="pathType"/>
        </collection>
    </resultMap>
</mapper>

<!--
{
  "code" : "200 성공",
  "totalDistance" : 200102000,
  "totalDuration" : 420,
  "scheduleCnt" : 12, (sm의 category 가 SCHE 인것들)
  "memoCnt" : 8, (sm의 category 가 MEMO 인것들)
  "days":[
    {
      "day" : 1, (sm 의 day)
      "weather" : "cloudy" or null, (api 사용)
      "schedules" : [
        {
          "seq" : 1, (sm 의 seq)
          "strfId" : 1, (s의 strf_id)
          "strfTitle" : "차이나 타운", (strf 의 title)
          "category" : "관광", (strf 의 category)
          "address" : "인천 중구", (strf 의 address)
          "lat" : 37.5664707, (strf 의 lat)
          "lng" : 127.0039404, (strf 의 lng)
          "distance" : 13920 or null, (오디세이)
          "duration" : 35 or null, (오디세이, totalTime)
          "pathtype" : "BUS" or null, (오디세이)
        },
        ...
      ]
   }
   ...
  ],
}
-->